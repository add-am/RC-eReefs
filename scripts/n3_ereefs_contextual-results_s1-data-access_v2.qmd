---
title: "eReefs Contextual Results - Data Access"
subtitle: "A Healthy Waters Partnership Analysis"
description: "This script has been written to create a series of contextual results to be included in the Offshore Marine Zone of the Technical Report."
author: "Adam Shand" 
format: html
---

::: {.callout-note}
This is one part of several scripts exploring CSIRO ereefs data. 
:::

# Introduction

The only objective of this script is to download data from the eReefs platform. For detailed explanations of this process, refer to earlier scripts such as ereefs script 6 (found in the archives).

A pair of custom functions have been written to assist in the data download and can be accessed from the RcTools package. The custom functions currently give access to the following variables:

 - Turbidity
 - Chlorophyll a
 - DIN
 - NH4
 - NO3
 - Secchi Depth
 - PH
 - Wind

You define the area to extract data from using an [sf object](https://r-spatial.github.io/sf/) and you define the time frame by providing a start and end date in the format "YYYY-MM-DD".

# Extract eReefs Data

The following code is all that is required to extract eReefs data:

```{r}

#update RcTools package if needed
#pak::pak("add-am/RcTools")

#load packages
library(RcTools)
library(sf)
library(dplyr)
library(tmap)

#make an sf object that defines the broad boundary of where to extract data from
my_sf_object <- st_read("data/n3_region.gpkg") |> 
  filter(Region == "Dry Tropics", Environment == "Marine")

#read data in using custom function
turbidity_data <- ereefs_extract(
  Region = my_sf_object, 
  StartDate = "2022-01-01", 
  EndDate = "2022-01-05", 
  Variable = "Turbidity"
)

#convert from curvilinear to regular grid using custom function
turbidity_data <- ereefs_reproject(turbidity_data)

```

# Generalised Extraction

Below is the code necessary to generalise the data extraction, simply create a matrix of input values and use pmap

```{r}

#put arguments into objects
all_variables <- c("Turbidity", "Chl_a_sum")
all_start_dates <- "2022-01-01"
all_end_dates <- "2022-01-05"

#use expand grid
all_arguments <- expand.grid(all_variables, all_start_dates, all_end_dates, stringsAsFactors = F)

#map over each argument, this returns a list of data extracts
test_extract <- purrr::pmap(all_arguments,  function(Var1, Var2, Var3){ereefs_extract(my_sf_object, Var2, Var3, Var1)})

#alternatively, you can manually build the table if you want more control (note that two different time spans are requested)
all_arguments_2 <- data.frame(
  "AllVariables" = c("Turbidity", "Chl_a_sum", "Turbidity", "Chl_a_sum"),
  "AllStartDates" = c("2022-01-01", "2022-01-01", "2023-01-01", "2023-01-01"),
  "AllEndDates" = c("2022-01-05", "2022-01-05", "2023-01-05", "2023-01-05")
)

```


```{r}

#how to save data
stars::write_mdim(final_data, "final.nc")

#how to read data back in
read_back_in <- stars::read_stars("final.nc")

  

```

This concludes the data access script.

```{r}

```